import json
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from typing import Dict, Optional, List


class LinkedInScraper:
    def __init__(self, li_at_cookie: str):
        """
        Inisialisasi LinkedIn Scraper dengan li_at cookie
        
        Args:
            li_at_cookie: LinkedIn session cookie (li_at value)
        """
        self.li_at_cookie = li_at_cookie
        self.driver = None
        
    def _init_driver(self):
        """Inisialisasi Selenium WebDriver"""
        chrome_options = Options()
        # Uncomment untuk headless mode (tanpa GUI)
        chrome_options.add_argument("--headless")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-blink-features=AutomationControlled")
        chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        # Disable images dan plugins untuk lebih cepat
        chrome_options.add_argument("--disable-images")
        chrome_options.add_argument("--disable-plugins")
        chrome_options.add_argument("--disable-extensions")
        
        self.driver = webdriver.Chrome(options=chrome_options)
        
    def _set_cookie(self):
        """Set li_at cookie ke browser"""
        self.driver.get("https://www.linkedin.com")
        time.sleep(2)
        
        self.driver.add_cookie({
            "name": "li_at",
            "value": self.li_at_cookie,
            "domain": ".linkedin.com"
        })
        
        time.sleep(1)
    
    def _clean_text(self, text: str) -> Optional[str]:
        """Bersihkan text dari duplikasi dan whitespace"""
        if not text:
            return None
        
        # Split by newline dan hapus duplikasi
        lines = text.split('\n')
        cleaned_lines = []
        prev_line = None
        
        for line in lines:
            line = line.strip()
            if line and line != prev_line:
                cleaned_lines.append(line)
                prev_line = line
        
        result = '\n'.join(cleaned_lines).strip()
        return result if result else None
    
    def scrape_profile(self, vanity_name: str) -> Dict:
        """
        Scrape profil LinkedIn berdasarkan vanity name
        
        Args:
            vanity_name: Vanity name LinkedIn (contoh: naufal-arga-a5b22b2aa)
            
        Returns:
            Dictionary berisi data profil
        """
        try:
            self._init_driver()
            self._set_cookie()
            
            # Buka profil LinkedIn
            profile_url = f"https://www.linkedin.com/in/{vanity_name}/"
            self.driver.get(profile_url)
            
            # Tunggu sampai profile-content selector dapet semua sebelum lanjut
            try:
                WebDriverWait(self.driver, 15).until(
                    EC.presence_of_all_elements_located((By.XPATH, "//*[@id='profile-content']"))
                )
            except:
                time.sleep(3)  # Fallback jika selector tidak ditemukan
            
            # Extract data profil
            profile_data = self._extract_profile_data()
            
            return profile_data
            
        except Exception as e:
            print(f"Error scraping profile: {str(e)}")
            return {
                "data": {},
                "message": f"Error: {str(e)}"
            }
        finally:
            if self.driver:
                self.driver.quit()
    
    def _extract_profile_data(self) -> Dict:
        """Extract data dari halaman profil LinkedIn menggunakan XPath"""
        data = {
            "data": {},
            "message": "ok"
        }
        
        try:
            profile_data = {}
            
            # Full Name - coba multiple XPath alternatives
            try:
                # Alternative 1: //*[@id="ember..."]/h1
                name_elem = self.driver.find_element(By.XPATH, "//h1[contains(@class, 'text-heading')]")
                full_name = self._clean_text(name_elem.text)
                profile_data["full_name"] = full_name
            except:
                try:
                    # Alternative 2: Full XPath div[6]
                    name_elem = self.driver.find_element(By.XPATH, "/html/body/div[6]/div[3]/div/div/div[2]/div/div/main/section[1]/div[2]/div[2]/div[1]/div[1]/span[1]/a/h1")
                    full_name = self._clean_text(name_elem.text)
                    profile_data["full_name"] = full_name
                except:
                    try:
                        # Alternative 3: Full XPath div[7]
                        name_elem = self.driver.find_element(By.XPATH, "/html/body/div[7]/div[3]/div/div/div[2]/div/div/main/section[1]/div[2]/div[2]/div[1]/div[1]/span[1]/a/h1")
                        full_name = self._clean_text(name_elem.text)
                        profile_data["full_name"] = full_name
                    except:
                        profile_data["full_name"] = None
            
            # Headline - coba multiple XPath alternatives
            try:
                headline_elem = self.driver.find_element(By.XPATH, "//*[@id='profile-content']/div/div[2]/div/div/main/section[1]/div[2]/div[2]/div[1]/div[2]")
                headline = self._clean_text(headline_elem.text)
                profile_data["headline"] = headline
            except:
                try:
                    # Fallback: cari dengan class selector
                    headline_elem = self.driver.find_element(By.XPATH, "//div[@class='text-body-medium' and contains(text(), ' ')]")
                    headline = self._clean_text(headline_elem.text)
                    profile_data["headline"] = headline
                except:
                    profile_data["headline"] = None
            
            # Location - coba multiple XPath alternatives
            try:
                location_elem = self.driver.find_element(By.XPATH, "//*[@id='profile-content']/div/div[2]/div/div/main/section[1]/div[2]/div[2]/div[2]/span[1]")
                location = self._clean_text(location_elem.text)
                profile_data["location"] = location
            except:
                try:
                    # Fallback: cari dengan class selector
                    location_elem = self.driver.find_element(By.XPATH, "//span[contains(text(), 'Indonesia') or contains(text(), 'Jakarta') or contains(text(), 'Malang')]")
                    location = self._clean_text(location_elem.text)
                    profile_data["location"] = location
                except:
                    profile_data["location"] = None
            
            # About - XPath: //*[@id="profile-content"]/div/div[2]/div/div/main/section[2]/div[3]/div/div/div/span[1]
            try:
                about_elem = self.driver.find_element(By.XPATH, "//*[@id='profile-content']/div/div[2]/div/div/main/section[2]/div[3]/div/div/div/span[1]")
                about = self._clean_text(about_elem.text)
                profile_data["about"] = about
            except:
                profile_data["about"] = None
            
            # Profile picture
            try:
                img_elem = self.driver.find_element(By.CSS_SELECTOR, "img.profile-photo-edit__preview")
                profile_data["profile_image_url"] = img_elem.get_attribute("src")
            except:
                profile_data["profile_image_url"] = None
            
            # Experience
            profile_data["experiences"] = self._extract_experiences()
            
            # Education
            profile_data["educations"] = self._extract_education()
            
            # Certifications
            profile_data["certifications"] = self._extract_certifications()
            
            # Skills
            profile_data["skills"] = self._extract_skills()
            
            data["data"] = profile_data
            return data
            
        except Exception as e:
            print(f"Error extracting profile data: {str(e)}")
            return data
    
    def _extract_experiences(self) -> List[Dict]:
        """Extract pengalaman kerja dengan XPath yang akurat - HANYA data lengkap"""
        experiences = []
        try:
            # Scroll ke section experience
            self.driver.execute_script("window.scrollBy(0, 500);")
            
            # Tunggu sampai experience section dapet semua sebelum lanjut
            try:
                WebDriverWait(self.driver, 10).until(
                    EC.presence_of_all_elements_located((By.XPATH, "//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li"))
                )
            except:
                time.sleep(2)
            
            # XPath untuk experience items
            exp_items = self.driver.find_elements(By.XPATH, "//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li")
            
            for idx, item in enumerate(exp_items):
                try:
                    exp_data = {}
                    li_index = idx + 1
                    
                    # Job Title - coba multiple XPath alternatives
                    title = None
                    try:
                        # Primary: //*[@id="profile-content"]/div/div[2]/div/div/main/section[4]/div[3]/ul/li[N]/div/div[2]/div[1]/a/div/div/div/div/span[1]
                        title_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/a/div/div/div/div/span[1]"
                        title_elem = self.driver.find_element(By.XPATH, title_xpath)
                        title = self._clean_text(title_elem.text)
                    except:
                        try:
                            # Alternative: div/div[2]/div/a/div/div/div/div/span[1]
                            title_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div/a/div/div/div/div/span[1]"
                            title_elem = self.driver.find_element(By.XPATH, title_xpath)
                            title = self._clean_text(title_elem.text)
                        except:
                            pass
                    
                    # Company - coba multiple XPath alternatives
                    company = None
                    try:
                        # Primary: //*[@id="profile-content"]/div/div[2]/div/div/main/section[4]/div[3]/ul/li[N]/div/div[2]/div[1]/a/span[1]/span[1]
                        company_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/a/span[1]/span[1]"
                        company_elem = self.driver.find_element(By.XPATH, company_xpath)
                        company = self._clean_text(company_elem.text)
                    except:
                        try:
                            # Alternative: div/div[2]/div/a/span[1]/span[1]
                            company_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div/a/span[1]/span[1]"
                            company_elem = self.driver.find_element(By.XPATH, company_xpath)
                            company = self._clean_text(company_elem.text)
                        except:
                            pass
                    
                    # Date Range - coba multiple XPath alternatives
                    date_range = None
                    try:
                        # Primary: //*[@id="profile-content"]/div/div[2]/div/div/main/section[4]/div[3]/ul/li[N]/div/div[2]/div[1]/a/span[2]/span[1]
                        date_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/a/span[2]/span[1]"
                        date_elem = self.driver.find_element(By.XPATH, date_xpath)
                        date_range = self._clean_text(date_elem.text)
                    except:
                        try:
                            # Alternative: div/div[2]/div/a/span[2]/span[1]
                            date_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div/a/span[2]/span[1]"
                            date_elem = self.driver.find_element(By.XPATH, date_xpath)
                            date_range = self._clean_text(date_elem.text)
                        except:
                            pass
                    
                    # Location - coba multiple XPath alternatives
                    location = None
                    try:
                        # Primary: //*[@id="profile-content"]/div/div[2]/div/div/main/section[4]/div[3]/ul/li[N]/div/div[2]/div[1]/a/span[3]/span[1]
                        location_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/a/span[3]/span[1]"
                        location_elem = self.driver.find_element(By.XPATH, location_xpath)
                        location = self._clean_text(location_elem.text)
                    except:
                        try:
                            # Alternative: div/div[2]/div/a/span[3]/span[1]
                            location_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[4]/div[3]/ul/li[{li_index}]/div/div[2]/div/a/span[3]/span[1]"
                            location_elem = self.driver.find_element(By.XPATH, location_xpath)
                            location = self._clean_text(location_elem.text)
                        except:
                            pass
                    
                    # VALIDASI KETAT: Hanya tambah jika SEMUA field ada (title, company, date_range, location)
                    if title and company and date_range and location:
                        exp_data["title"] = title
                        exp_data["company"] = company
                        exp_data["date_range"] = date_range
                        exp_data["location"] = location
                        experiences.append(exp_data)
                    else:
                        print(f"Experience item {idx} SKIP - data tidak lengkap (title={bool(title)}, company={bool(company)}, date={bool(date_range)}, location={bool(location)})")
                        
                except Exception as e:
                    print(f"Error parsing experience item {idx}: {str(e)}")
                    pass
                    
        except Exception as e:
            print(f"Error extracting experiences: {str(e)}")
        
        return experiences
    
    def _extract_education(self) -> List[Dict]:
        """Extract pendidikan dengan XPath yang akurat - HANYA data lengkap"""
        education = []
        try:
            # XPath untuk education items
            edu_items = self.driver.find_elements(By.XPATH, "//*[@id='profile-content']/div/div[2]/div/div/main/section[5]/div[3]/ul/li")
            
            for idx, item in enumerate(edu_items):
                try:
                    li_index = idx + 1
                    
                    # School Name - coba multiple XPath alternatives
                    school = None
                    try:
                        # Primary: //*[@id="profile-content"]/div/div[2]/div/div/main/section[5]/div[3]/ul/li/div/div[2]/div/a/div/div/div/div/span[1]
                        school_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[5]/div[3]/ul/li[{li_index}]/div/div[2]/div/a/div/div/div/div/span[1]"
                        school_elem = self.driver.find_element(By.XPATH, school_xpath)
                        school = self._clean_text(school_elem.text)
                    except:
                        try:
                            # Alternative: div/div[2]/div[1]/a/div/div/div/div/span[1]
                            school_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[5]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/a/div/div/div/div/span[1]"
                            school_elem = self.driver.find_element(By.XPATH, school_xpath)
                            school = self._clean_text(school_elem.text)
                        except:
                            pass
                    
                    # Degree & Field of Study - coba multiple XPath alternatives
                    degree = None
                    try:
                        # Primary: //*[@id="profile-content"]/div/div[2]/div/div/main/section[5]/div[3]/ul/li/div/div[2]/div/a/span[1]/span[1]
                        degree_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[5]/div[3]/ul/li[{li_index}]/div/div[2]/div/a/span[1]/span[1]"
                        degree_elem = self.driver.find_element(By.XPATH, degree_xpath)
                        degree = self._clean_text(degree_elem.text)
                    except:
                        try:
                            # Alternative: div/div[2]/div[1]/a/span[1]/span[1]
                            degree_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[5]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/a/span[1]/span[1]"
                            degree_elem = self.driver.find_element(By.XPATH, degree_xpath)
                            degree = self._clean_text(degree_elem.text)
                        except:
                            pass
                    
                    # Date Range - coba multiple XPath alternatives
                    date_range = None
                    try:
                        # Primary: //*[@id="profile-content"]/div/div[2]/div/div/main/section[5]/div[3]/ul/li/div/div[2]/div/a/span[2]/span[1]
                        date_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[5]/div[3]/ul/li[{li_index}]/div/div[2]/div/a/span[2]/span[1]"
                        date_elem = self.driver.find_element(By.XPATH, date_xpath)
                        date_range = self._clean_text(date_elem.text)
                    except:
                        try:
                            # Alternative: div/div[2]/div[1]/a/span[2]/span[1]
                            date_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[5]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/a/span[2]/span[1]"
                            date_elem = self.driver.find_element(By.XPATH, date_xpath)
                            date_range = self._clean_text(date_elem.text)
                        except:
                            pass
                    
                    # VALIDASI KETAT: Hanya tambah jika SEMUA field ada (school, degree, date_range)
                    if school and degree and date_range:
                        edu_data = {
                            "school": school,
                            "degree": degree,
                            "date_range": date_range
                        }
                        education.append(edu_data)
                    else:
                        print(f"Education item {idx} SKIP - data tidak lengkap (school={bool(school)}, degree={bool(degree)}, date={bool(date_range)})")
                        
                except Exception as e:
                    print(f"Error parsing education item {idx}: {str(e)}")
                    pass
                    
        except Exception as e:
            print(f"Error extracting education: {str(e)}")
            return []
        
        return education
    
    def _extract_certifications(self) -> List[Dict]:
        """Extract certifications dengan XPath yang akurat - HANYA data lengkap"""
        certifications = []
        try:
            # XPath untuk certification items
            cert_items = self.driver.find_elements(By.XPATH, "//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li")
            
            for idx, item in enumerate(cert_items):
                try:
                    li_index = idx + 1
                    
                    # Certification Name - coba multiple XPath alternatives
                    name = None
                    try:
                        # Alternative 1: div/div[2]/div[1]/div/div/div/div/div/span[1]
                        name_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/div/div/div/div/div/span[1]"
                        name_elem = self.driver.find_element(By.XPATH, name_xpath)
                        name = self._clean_text(name_elem.text)
                    except:
                        try:
                            # Alternative 2: div/div[2]/div/div/div/div/div/span[1]
                            name_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div/div/div/div/div/span[1]"
                            name_elem = self.driver.find_element(By.XPATH, name_xpath)
                            name = self._clean_text(name_elem.text)
                        except:
                            pass
                    
                    # Authority/Issuer - coba multiple XPath alternatives
                    authority = None
                    try:
                        # Alternative 1: div/div[2]/div[1]/div/span[1]/span[1]
                        authority_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/div/span[1]/span[1]"
                        authority_elem = self.driver.find_element(By.XPATH, authority_xpath)
                        authority = self._clean_text(authority_elem.text)
                    except:
                        try:
                            # Alternative 2: div/div[2]/div/div/span[1]/span[1]
                            authority_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div/div/span[1]/span[1]"
                            authority_elem = self.driver.find_element(By.XPATH, authority_xpath)
                            authority = self._clean_text(authority_elem.text)
                        except:
                            pass
                    
                    # Issued Date - coba multiple XPath alternatives
                    issued = None
                    try:
                        # Alternative 1: div/div[2]/div[1]/div/span[2]/span[1]
                        issued_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/div/span[2]/span[1]"
                        issued_elem = self.driver.find_element(By.XPATH, issued_xpath)
                        issued = self._clean_text(issued_elem.text)
                    except:
                        try:
                            # Alternative 2: div/div[2]/div/div/span[2]/span[1]
                            issued_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div/div/span[2]/span[1]"
                            issued_elem = self.driver.find_element(By.XPATH, issued_xpath)
                            issued = self._clean_text(issued_elem.text)
                        except:
                            pass
                    
                    # Credential ID - coba multiple XPath alternatives
                    credential_id = None
                    try:
                        # Alternative 1: div/div[2]/div[1]/div/span[3]/span[1]
                        credential_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div[1]/div/span[3]/span[1]"
                        credential_elem = self.driver.find_element(By.XPATH, credential_xpath)
                        credential_id = self._clean_text(credential_elem.text)
                    except:
                        try:
                            # Alternative 2: div/div[2]/div/div/span[3]/span[1]
                            credential_xpath = f"//*[@id='profile-content']/div/div[2]/div/div/main/section[6]/div[3]/ul/li[{li_index}]/div/div[2]/div/div/span[3]/span[1]"
                            credential_elem = self.driver.find_element(By.XPATH, credential_xpath)
                            credential_id = self._clean_text(credential_elem.text)
                        except:
                            pass
                    
                    # VALIDASI KETAT: Hanya tambah jika SEMUA field ada (name, authority, issued, credential_id)
                    if name and authority and issued and credential_id:
                        cert_data = {
                            "name": name,
                            "authority": authority,
                            "issued": issued,
                            "credential_id": credential_id
                        }
                        certifications.append(cert_data)
                    else:
                        print(f"Certification item {idx} SKIP - data tidak lengkap (name={bool(name)}, authority={bool(authority)}, issued={bool(issued)}, credential_id={bool(credential_id)})")
                        
                except Exception as e:
                    print(f"Error parsing certification item {idx}: {str(e)}")
                    pass
                    
        except Exception as e:
            print(f"Error extracting certifications: {str(e)}")
            return []
        
        return certifications
    
    def _extract_skills(self) -> str:
        """Extract skills dari halaman details/skills/"""
        skills = []
        try:
            # Navigasi ke halaman skills
            profile_url = self.driver.current_url
            skills_url = profile_url.rstrip("/") + "/details/skills/"
            self.driver.get(skills_url)
            
            # Tunggu sampai skill items dapet semua sebelum lanjut
            try:
                WebDriverWait(self.driver, 10).until(
                    EC.presence_of_all_elements_located((By.XPATH, "/html/body/div[6]/div[3]/div/div/div[2]/div/div/main/section/div[2]/div[2]/div/div/div[1]/ul/li"))
                )
            except:
                time.sleep(2)

            skill_items = self.driver.find_elements(By.XPATH, "/html/body/div[6]/div[3]/div/div/div[2]/div/div/main/section/div[2]/div[2]/div/div/div[1]/ul/li/div/div/div[2]/div[1]/a/div/div/div/div/span[1]")
            
            for item in skill_items:
                try:
                    skill_text = self._clean_text(item.text)
                    if skill_text:
                        skills.append(skill_text)
                except:
                    pass
            
            # Return sebagai string yang dipisahkan dengan pipe
            return "|".join(skills) if skills else ""
            
        except Exception as e:
            print(f"Error extracting skills: {str(e)}")
            return ""
